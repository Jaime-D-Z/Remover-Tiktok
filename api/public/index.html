<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TikTok Downloader sin Marca de Agua - Descarga F√°cil</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-papmYp4gKXtVfQ+vYxR4ri+Kaa4bDFFwrRSP2lWqKhztCxyXd95Bz8e0K5i6+qC+xB3L6yL9p/ZZF1z7Et1w3g=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body>
  <header class="navbar navbar-expand-lg custom-navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">TikTok Downloader</a>
      <div class="form-check form-switch ms-auto me-3">
        <input class="form-check-input" type="checkbox" id="darkModeToggle" />
        <label class="form-check-label" for="darkModeToggle">Modo Oscuro</label>
      </div>
    </div>
  </header>

  <div class="container text-center mt-5 content-section">
    <h1 class="mb-4 display-5">
      Descarga Videos de TikTok <br />
      <span class="highlight">Sin Marca de Agua</span> üåÄ
    </h1>
    <p class="lead mb-4">
      Pega el enlace del video de TikTok a continuaci√≥n y obt√©n tu descarga gratis.
    </p>

    <div class="input-group mb-4 w-75 mx-auto shadow-sm">
      <input
        id="tiktokUrl"
        type="text"
        class="form-control form-control-lg"
        placeholder="Ej: https://www.tiktok.com/@usuario/video/1234567890"
        aria-label="Enlace de TikTok"
      />
      <button id="downloadBtn" class="btn btn-primary btn-lg">
        Obtener Video
      </button>
    </div>

    <div id="result" class="mt-4 p-3 rounded shadow-sm"></div>
  </div>

  <footer class="footer mt-auto py-3">
    <div class="container text-center">
      <span class="text-muted">&copy; 2025 TikTok Downloader. Todos los derechos reservados.</span>
    </div>
  </footer>

  <script>
    const btn = document.getElementById("downloadBtn");
    const result = document.getElementById("result");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const body = document.body;

    // Cargar preferencia de Dark Mode
    if (localStorage.getItem("darkMode") === "enabled") {
      body.classList.add("dark-mode");
      darkModeToggle.checked = true;
    }

    darkModeToggle.addEventListener("change", () => {
      if (darkModeToggle.checked) {
        body.classList.add("dark-mode");
        localStorage.setItem("darkMode", "enabled");
      } else {
        body.classList.remove("dark-mode");
        localStorage.setItem("darkMode", "disabled");
      }
    });

    btn.addEventListener("click", async () => {
      const url = document.getElementById("tiktokUrl").value.trim();
      if (!url) {
        result.innerHTML = '<p class="text-warning">‚ö†Ô∏è Por favor, ingresa un enlace de TikTok.</p>';
        return;
      }

      result.innerHTML = '<p class="text-info">‚è≥ Resolviendo enlace...</p>';

      try {
        // ‚úÖ Cambi√© fetch a rutas relativas para Vercel
        const resolveResp = await fetch("/api/resolve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });

        if (!resolveResp.ok) throw new Error(`HTTP ${resolveResp.status}`);
        const resolveData = await resolveResp.json();

        if (!resolveData.videoId) {
          result.innerHTML = `<p class="text-danger">‚ùå Error: ${resolveData.error || "No se pudo resolver el enlace."}</p>`;
          return;
        }

        const { videoId } = resolveData;
        result.innerHTML = `<p class="text-info">üîç Video ID detectado: ${videoId}</p><p class="text-info">‚è≥ Obteniendo enlace de descarga...</p>`;

        const downloadResp = await fetch("/api/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ videoId }),
        });

        if (!downloadResp.ok) throw new Error(`HTTP ${downloadResp.status}`);
        const downloadData = await downloadResp.json();

        if (downloadData.download_url) {
          result.innerHTML = `
            <p class="text-success">‚úÖ ¬°Video listo para descargar!</p>
            <a 
              href="${downloadData.download_url}" 
              class="btn btn-success btn-lg download-btn" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              <i class="fas fa-download me-2"></i> Descargar sin marca de agua
            </a>
          `;
        } else {
          result.innerHTML = `<p class="text-danger">‚ùå Error: ${downloadData.error || "No se pudo obtener el video."}</p>`;
        }
      } catch (error) {
        console.error("Error general:", error);
        result.innerHTML = `<p class="text-danger">‚ùå Ocurri√≥ un error inesperado: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>
